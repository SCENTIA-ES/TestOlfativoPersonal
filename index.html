<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCENTIA IA ¬∑ Tu Perfume Unico</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Exo+2:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ------------------------------------- */
/* 1. CSS VARIABLES & BASE STYLES */
/* --- STRICT PALETTE IMPLEMENTATION --- */
:root {
  /* Principal: Midnight Blue */
  --color-primary-dark: #1A1F3B; 
  --color-secondary-dark: #252B4E; /* Slightly lighter shade for contrast elements */
  
  /* Accent: Soft Sage/Mint */
  --color-accent: #A8C3A1; 
  
  /* Secondary/Subtle: Silver/Pearl Gray */
  --color-text-light: #f0f0f0; 
  --color-text-subtle: #C0C0C0; 
  
  /* Background: Very Dark Blue/Black for depth */
  --bg-body: #0a0e1b; 
  
  /* Bubble definitions */
  --bubble-bot: var(--color-secondary-dark); 
  --bubble-user: #353B62; /* Darker blue for user input/bubble for clear distinction */
  
  /* CTA definitions */
  --cta-bg: var(--color-accent); 
  --cta-text: var(--color-primary-dark); 
}

body {
  font-family: 'Exo 2', sans-serif; 
  margin: 0; padding: 0;
  background-color: var(--bg-body);
  display: flex; justify-content: center; align-items: center;
  min-height: 100vh;
  color: var(--color-text-light); 
  overflow: hidden;
  line-height: 1.6;
}

/* ------------------------------------- */
/* 2. LAYOUT & CONTAINER */
/* ------------------------------------- */
.chat-container {
  width: 95%; max-width: 950px;
  background: var(--color-primary-dark); /* Midnight Blue */
  border-radius: 15px;
  display: flex; flex-direction: column;
  height: 95vh;
  box-shadow: 0 0 70px rgba(0, 0, 0, 0.8);
  overflow: hidden;
  border: 1px solid #333;
}
.chat-header {
  background: var(--bg-body); 
  padding: 30px 40px 20px;
  text-align: center;
  font-family: 'Playfair Display', serif;
  font-size: 34px; 
  font-weight: 700;
  color: var(--color-accent); /* Soft Mint/Sage */
  letter-spacing: 5px; 
  text-transform: uppercase;
  border-bottom: 4px double var(--color-text-subtle); /* Silver/Pearl Gray */
}
.chat-header span {
    display: block;
    font-size: 16px;
    color: var(--color-text-subtle);
    margin-top: 10px;
    letter-spacing: 3px;
    font-weight: 300;
}

/* ------------------------------------- */
/* 3. CHAT WINDOW & MESSAGES */
/* ------------------------------------- */
.chat-window {
  flex: 1;
  padding: 25px 40px;
  overflow-y: auto;
  z-index: 1;
}
.message {
  max-width: 85%;
  padding: 18px 22px;
  margin: 14px 0;
  border-radius: 20px; 
  font-size: 16px;
  border: 1px solid transparent; 
  opacity: 0;
  transform: translateY(15px);
  animation: message-fade-in 0.3s forwards cubic-bezier(0.2, 0.8, 0.2, 1.0);
}
@keyframes message-fade-in { 
    to { opacity: 1; transform: translateY(0); } 
}

.bot { 
    background: var(--bubble-bot); 
    border-color: #3f476e; 
    border-radius: 20px 20px 20px 6px; 
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
}
.user { 
    background: var(--bubble-user); 
    border-radius: 20px 20px 6px 20px; 
    margin-left: auto;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
}
.bot strong { color: var(--color-accent); font-weight: 600; } /* Mint accent on strong text */ 

.terms-message {
    border-left: 5px solid var(--color-accent); /* Mint accent line */
    background: var(--color-secondary-dark); 
    font-weight: 300;
    animation: pulse-border 1.5s infinite alternate;
}
@keyframes pulse-border {
    from { border-color: var(--color-accent); }
    to { border-color: rgba(168, 195, 161, 0.5); } 
}
.revelation-message {
    background: var(--color-accent); /* Mint background */
    color: var(--color-primary-dark); /* Midnight Blue text */
    box-shadow: 0 0 50px rgba(168, 195, 161, 0.8); 
    font-size: 26px; 
    padding: 35px 45px;
    letter-spacing: 3px;
    font-family: 'Playfair Display', serif;
}

/* 4. INPUT & BUTTONS */
.chat-input {
  display: flex;
  padding: 25px 40px;
  background: var(--color-primary-dark);
  border-top: 1px solid var(--bubble-user); 
}
.chat-input input, .chat-input select {
  padding: 16px 22px;
  border-radius: 35px;
  border: 1px solid var(--bubble-user);
  background: var(--bubble-user); 
  color: var(--color-text-light);
  font-size: 17px;
  margin-right: 10px;
}
.chat-input input {
    flex: 1;
}
/* New Phone Input Group Styling */
.phone-input-group {
    display: flex;
    flex: 1;
    align-items: center;
}
.phone-input-group select {
    flex: none; 
    width: 130px; 
    border-radius: 35px;
    background-color: var(--bubble-user);
    color: var(--color-text-light);
    border: 1px solid var(--bubble-user);
    appearance: none; 
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%23A8C3A1"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>');
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 1em;
    padding-right: 35px;
}
.phone-input-group input {
    flex: 1;
    border-left: none; 
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    padding-left: 10px;
    margin-right: 0;
}
.chat-input button {
  margin-left: 15px;
  background: var(--color-accent); /* Mint */
  border: 2px solid var(--color-accent); 
  color: var(--color-primary-dark); /* Midnight Blue text */
  font-weight: 600;
  padding: 16px 35px;
  border-radius: 35px;
  cursor: pointer;
  box-shadow: 0 6px 15px rgba(168, 195, 161, 0.5); 
  letter-spacing: 1px;
  transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
}
.chat-input button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* 5. PRODUCT CARD STYLES */
.fragrance-card {
  background: var(--color-secondary-dark); 
  border: 3px solid var(--color-accent); /* Mint border */
  padding: 40px; 
  border-radius: 18px;
  box-shadow: 0 0 40px rgba(168, 195, 161, 0.3); 
}
.fragrance-card h3 { 
    font-family: 'Playfair Display', serif; 
    font-size: 32px; 
    letter-spacing: 1px;
    color: var(--color-accent); /* Mint */
} 

.story-box {
    background: var(--color-primary-dark);
    padding: 30px;
    border-radius: 12px;
    margin: 30px 0 15px;
    border: 1px solid var(--color-text-subtle); /* Silver line */
    font-style: italic;
    font-size: 16px;
    box-shadow: 0 0 15px rgba(168, 195, 161, 0.15); 
}
.story-box h4 {
    font-family: 'Playfair Display', serif;
    color: var(--color-accent); /* Mint */
    font-size: 22px;
    border-bottom: 2px solid var(--color-text-subtle);
    padding-bottom: 8px;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* OLFACTIVE PYRAMID */
.olfactive-pyramid {
    margin: 40px 0;
    text-align: center;
    position: relative;
    padding-top: 20px;
    border-top: 1px solid var(--color-text-subtle); /* Silver Line */
}
.olfactive-pyramid h4 {
    font-family: 'Playfair Display', serif;
    color: var(--color-accent); /* Mint */
    font-size: 24px;
    margin-bottom: 30px;
}
.note-layer {
    background: var(--color-primary-dark);
    border: 1px solid var(--color-secondary-dark);
    padding: 15px 25px;
    margin-bottom: 15px;
    border-radius: 8px;
    text-align: left;
    transition: transform 0.3s ease-in-out;
}
.note-layer:hover { transform: scale(1.02); }

.layer-title {
    font-family: 'Playfair Display', serif;
    color: var(--color-accent); /* Mint */
    font-size: 18px;
    margin-bottom: 5px;
    font-weight: 600;
    display: block;
    border-bottom: 1px dashed var(--color-text-subtle);
    padding-bottom: 5px;
}
.layer-content {
    color: var(--color-text-light);
    font-size: 15px;
    padding-top: 5px;
    line-height: 1.5;
}

/* Flask and Swatches Styling */
#flask-preview-container {
    padding: 30px 20px;
    border-radius: 12px;
    border: 2px dashed var(--color-text-subtle); /* Silver dashed border for preview */
    text-align: center;
}
#flask-image {
    max-width: 180px;
    border: 4px solid var(--color-accent) !important; /* Mint border for the flask image in the selection */
    border-radius: 10px;
    transition: transform 0.3s;
}
.color-swatches {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
}
.color-swatch {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border 0.2s, box-shadow 0.2s;
}
.color-swatch:hover {
    border-color: var(--color-accent);
}
.color-swatch.selected { 
    border-color: var(--color-accent); 
    box-shadow: 0 0 0 2px var(--color-primary-dark), 0 0 0 4px var(--color-accent); 
}

/* Individual Color Mapping (For visual representation) */
.color-swatch[title="Perla Mate"] { background-color: #f0f0f0; }
.color-swatch[title="Oro Rosado"] { background-color: #B76E79; }
.color-swatch[title="Negro √ìnix"] { background-color: #111111; }
.color-swatch[title="Oro Brillante"] { background-color: #D4AF37; }
.color-swatch[title="Esmeralda Oscura"] { background-color: #004d40; }
.color-swatch[title="Rub√≠ Profundo"] { background-color: #8b0000; }
.color-swatch[title="Topacio Ahumado"] { background-color: #4a3d3c; }


/* Typing Indicator (Mint Dots) */
.typing-indicator span {
    background-color: var(--color-accent); 
}

/* --- CTA BAR STYLING --- */
.purchase-cta-bar {
    background: var(--cta-bg); 
    color: var(--cta-text); 
    box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.5);
    font-weight: 700;
    font-size: 20px;
    letter-spacing: 2px;
    padding: 20px 35px;
    margin: 30px -40px -40px; 
    width: calc(100% + 80px); 
    border: none;
    border-radius: 0 0 15px 15px; 
    cursor: pointer;
    text-transform: uppercase;
    transition: background 0.3s, transform 0.3s, opacity 0.3s;
    text-align: center;
}
.purchase-cta-bar:hover { 
    background: #90ab8a; 
    transform: translateY(-2px);
    opacity: 0.95;
}

</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">SCENTIA AI ¬∑ <span>ATELIER PRIV√âE</span></div>
  <div id="chat-window" class="chat-window"></div>
  <div id="typing-indicator" class="typing-indicator"><span></span><span></span><span></span></div>
  <div class="chat-input">
    <div id="current-input" class="phone-input-group">
        <input id="user-input" type="text" placeholder="Escribe tu respuesta y presiona Enter o Enviar...">
    </div>
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
// --- GLOBAL DATA & CONSTANTS (Remains unchanged) ---
const flaskImages = {
    'Perla Mate': 'https://i.postimg.cc/Jz91dfR6/Gemini-Generated-Image-f2t76hf2t76hf2t7.png', 
    'Oro Rosado': 'https://i.postimg.cc/7ZpxQFqB/Gemini-Generated-Image-61s8gg61s8gg61s8.png', 
    'Negro √ìnix': 'https://i.postimg.cc/YCJpy5tJ/Gemini-Generated-Image-xxa54hxxa54hxxa5.png', 
    'Oro Brillante': 'https://i.postimg.cc/fR6wgGMc/Gemini-Generated-Image-7crlli7crlli7crl.png', 
    'Esmeralda Oscura': 'https://i.postimg.cc/MphWrCz5/Gemini-Generated-Image-14pzf514pzf514pz.png', 
    'Rub√≠ Profundo': 'https://i.postimg.cc/L8q9D9F1/Gemini-Generated-Image-5w2ila5w2ila5w2i.png', 
    'Topacio Ahumado': 'https://i.postimg.cc/6pD91k9X/Gemini-Generated-Image-z7flsuz7flsuz7fl.png' 
};

// All steps are now 11
const baseQuestions = [
  "<strong>Paso 0/11: Aceptaci√≥n Legal.</strong> Al continuar, aceptas los <a href='#' target='_blank'>T√©rminos y Condiciones</a> y la Pol√≠tica de Privacidad de SCENTIA IA. Para aceptar y comenzar, escribe <STRONG>ACEPTO</STRONG>.",
  "<strong>Paso 1/11: Identidad.</strong> Escribe tu <STRONG>nombre de pila</STRONG>.",
  "<strong>Paso 2/11: Identidad.</strong> Gracias, [NAME]. Ahora, tu <STRONG>apellido</STRONG>.",
  "<strong>Paso 3/11: Contacto.</strong> [NAME], ingresa tu <STRONG>n√∫mero de tel√©fono</STRONG> (Confidencialidad m√°xima).",
  "<strong>Paso 4/11: Base.</strong> [NAME], ¬øcu√°l es tu <STRONG>g√©nero</STRONG>? (Masculino / Femenino / No Binario / Prefiero no decir).",
  "<strong>Paso 5/11: Olfativo.</strong> [NAME], ¬øqu√© familias de <STRONG>aromas prefieres</STRONG>? (C√≠tricos üçã, Florales üå∏, Amaderados üå≤, Dulces üçØ, Especiados üå∂Ô∏è, Acu√°ticos üíß)",
  "<strong>Paso 6/11: Proyecci√≥n.</strong> [NAME], ¬øprefieres una fragancia suave, <STRONG>moderada</STRONG> (uso diario) o <STRONG>intensa</STRONG> (m√°xima fijaci√≥n)?",
  "<strong>Paso 7/11: Ocasi√≥n.</strong> [NAME], ¬øen qu√© <STRONG>contexto principal</STRONG> usar√≠as tu perfume? (Diario/Oficina, Noche/Social, Eventos/Gala, Relajaci√≥n/Hogar)",
  "<strong>Paso 8/11: Intenci√≥n.</strong> [NAME], ¬øqu√© <STRONG>emoci√≥n</STRONG> deseas evocar con tu perfume? (Poder/Confianza, Calma/Bienestar, Sensualidad/Misterio, Alegr√≠a/Vitalidad)",
  "<strong>Paso 9/11: Frasco Atelier.</strong> [NAME], selecciona el <STRONG>color del frasco</STRONG> que encapsular√° tu esencia. (Perla Mate, Oro Rosado, Negro √ìnix, Oro Brillante, Esmeralda Oscura, Rub√≠ Profundo, Topacio Ahumado).",
  "<strong>Paso 10/11: Firma Personal.</strong> [NAME], cu√©ntanos una <STRONG>an√©cdota breve, un recuerdo significativo o un lugar</STRONG> que haya marcado tu vida. <span style='color: var(--color-text-subtle); font-style: italic; display: block; margin-top: 5px; font-size: 14px;'>(Ejemplo: 'El aroma de las flores de mi abuela' o 'La ma√±ana despu√©s de la tormenta en el mar').</span>",
  "<strong>Paso 11/11: Ecosistema.</strong> [NAME], ¬ødeseas que tu perfume combine con otros productos SCENTIA (velas, cremas)? (S√≠/No)"
];

// List of Country Codes (for Step 3)
const countryCodes = [
    { code: "+1", name: "EE. UU. / Canad√°" }, { code: "+52", name: "M√©xico" },
    { code: "+34", name: "Espa√±a" }, { code: "+54", name: "Argentina" },
    { code: "+56", name: "Chile" }, { code: "+57", name: "Colombia" },
    { code: "+51", name: "Per√∫" }, { code: "+58", name: "Venezuela" },
    { code: "+44", name: "Reino Unido" }, { code: "+33", name: "Francia" },
    { code: "+49", name: "Alemania" }, { code: "+39", name: "Italia" },
    { code: "+86", name: "China" }, { code: "+91", name: "India" },
    { code: "+81", name: "Jap√≥n" }, { code: "+61", name: "Australia" }
];


// --- DOM ELEMENTS & STATE ---
const chatWindow = document.getElementById("chat-window");
const currentInputContainer = document.getElementById("current-input");
const sendBtn = document.getElementById("send-btn");
const typingIndicator = document.getElementById("typing-indicator");

let answers = [];
let currentQuestion = 0;
let selectedFlaskColor = 'Perla Mate'; // Default


// --- CHAT FUNCTIONS ---

// 1. Adds a message bubble to the chat window
function addMessage(text, sender="bot", className=""){
  const msg = document.createElement("div");
  msg.innerHTML = text; 
  msg.style.animationDelay = `${(chatWindow.children.length) * 0.05}s`;
  msg.className = "message "+sender + (className ? " " + className : "");
  chatWindow.appendChild(msg);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// 2. Shows the typing indicator for a specified duration (simulates thinking)
function showTypingIndicator(duration = 800) {
    typingIndicator.style.display = 'flex';
    chatWindow.scrollTop = chatWindow.scrollHeight;
    return new Promise(resolve => setTimeout(() => {
        typingIndicator.style.display = 'none';
        resolve();
    }, duration));
}

// 3. Handles the bot asking the next question, incorporating the thinking delay
async function botAskNext(){
    if (currentQuestion > 0) {
        await showTypingIndicator(800); // Wait 0.8s for the bot to "think"
    }
    
    // Check if the input type needs to change (Step 3: Phone, Step 9: Flask Color)
    if (currentQuestion === 3) { 
        createPhoneInput();
    } else if (currentQuestion === 9) {
        // For Step 9, we disable the button until a color is selected
        sendBtn.disabled = true;
        createFlaskColorInput();
    } else {
        createStandardInput();
    }


    if(currentQuestion < baseQuestions.length){
        const firstName = answers[1] || "Cliente"; 
        let questionText = baseQuestions[currentQuestion];
        
        if (currentQuestion > 1 && firstName !== "Cliente") {
            questionText = questionText.replace('[NAME]', `<STRONG>${firstName}</STRONG>`);
        }

        addMessage(questionText,"bot", currentQuestion === 0 ? "terms-message" : "");
    } else {
        // End of questions, generate result
        setTimeout(generatePerfumeDemo, 500);
    }
}

// 4. Creates the input fields based on the current step

function createStandardInput() {
    currentInputContainer.innerHTML = `<input id="user-input" type="text" placeholder="Escribe tu respuesta y presiona Enter o Enviar...">`;
    // Ensure the input group class is reset for standard input
    currentInputContainer.className = 'phone-input-group'; 
    sendBtn.textContent = "Enviar";
    sendBtn.disabled = false;
    
    // Re-bind the enter key and focus
    const userInput = document.getElementById("user-input");
    if(userInput) {
        userInput.addEventListener("keypress", handleEnterKey);
        userInput.focus();
    }
}

function createPhoneInput() {
    let phoneInputHTML = `
        <select id="country-code">
            ${countryCodes.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`).join('')}
        </select>
        <input id="user-input" type="number" placeholder="Ej. 123 456 7890">
    `;
    currentInputContainer.innerHTML = phoneInputHTML;
    currentInputContainer.className = 'phone-input-group';
    sendBtn.textContent = "Enviar";
    sendBtn.disabled = false;
    
    const userInput = document.getElementById("user-input");
    if(userInput) {
        userInput.addEventListener("keypress", handleEnterKey);
        userInput.focus();
    }
}

function createFlaskColorInput() {
    // Hide standard input field for the Flask selection step
    currentInputContainer.innerHTML = '';
    currentInputContainer.className = 'color-selection-display'; 
    sendBtn.textContent = "Selecciona un Color"; // Initial disabled text
    
    // Create the message bubble containing the selection interface
    addMessage(`
        <div class="color-selection" style="text-align: center;">
            <p style="color: var(--color-accent); margin-bottom: 20px;">Selecciona el cristal de tu frasco:</p>
            <div id="flask-preview-container" style="border: none; padding: 0;">
                <img id="flask-image" src="${flaskImages[selectedFlaskColor]}" alt="Frasco de Perfume Personalizado" style="max-width: 150px; margin-bottom: 20px; border: 2px solid var(--color-accent); border-radius: 8px;">
            </div>
            <div class="color-swatches">
                <div class="color-swatch selected" title="Perla Mate" onclick="window.selectColor(this)"></div>
                <div class="color-swatch" title="Oro Rosado" onclick="window.selectColor(this)"></div>
                <div class="color-swatch" title="Negro √ìnix" onclick="window.selectColor(this)"></div>
                <div class="color-swatch" title="Oro Brillante" onclick="window.selectColor(this)"></div>
                <div class="color-swatch" title="Esmeralda Oscura" onclick="window.selectColor(this)"></div>
                <div class="color-swatch" title="Rub√≠ Profundo" onclick="window.selectColor(this)"></div>
                <div class="color-swatch" title="Topacio Ahumado" onclick="window.selectColor(this)"></div>
            </div>
        </div>
    `, 'bot', 'flask-selection-message');
    
    // Ensure the default color is selected visually
    const defaultSwatch = chatWindow.querySelector(`.color-swatch[title="${selectedFlaskColor}"]`);
    if (defaultSwatch) {
        window.selectColor(defaultSwatch);
    }
}


// --- HANDLERS FOR USER INTERACTION ---

// Handler for the Enter key press
function handleEnterKey(e){
    if(e.key==="Enter"){ e.preventDefault(); document.getElementById("send-btn").click(); }
}

// Global function to handle flask color selection
window.selectColor = function(element) {
    const container = element.closest('.color-swatches');
    container.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.remove('selected'));
    element.classList.add('selected');

    const colorName = element.getAttribute('title');
    selectedFlaskColor = colorName;

    // Update the image preview immediately
    const flaskImageElement = document.getElementById('flask-image');
    if (flaskImageElement) {
        flaskImageElement.src = flaskImages[colorName];
    }
    
    // *** FIX: Re-enable the send button and update its text ***
    sendBtn.disabled = false;
    sendBtn.textContent = `Confirmar ${colorName}`;
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// 5. Main click handler for the 'Enviar' button
sendBtn.addEventListener("click",()=>{
    let text = "";
    const questionIndex = currentQuestion;

    // 1. Retrieve the text based on the input type
    if (questionIndex === 9) {
        // *** FIX: Flask color step - Use the global variable for the answer ***
        text = selectedFlaskColor;
    } else if (questionIndex === 3) {
        // Phone number step
        const countryCode = document.getElementById("country-code").value;
        const number = document.getElementById("user-input").value.trim();
        text = countryCode + " " + number;
    } else {
        // Standard text input
        const userInput = document.getElementById("user-input");
        text = userInput ? userInput.value.trim() : "";
    }


    // 2. Validation
    if(!text) {
        addMessage("‚ö†Ô∏è Por favor, introduce una respuesta v√°lida.", "bot");
        return;
    }
    if (questionIndex === 0 && text.toUpperCase() !== 'ACEPTO') {
        addMessage("‚ö†Ô∏è Para continuar con la formulaci√≥n de tu perfume, debes escribir <STRONG>ACEPTO</STRONG>.", "bot");
        return;
    }
    if ((questionIndex === 1 || questionIndex === 2 || questionIndex === 10) && text.length < 2) {
        addMessage("‚ö†Ô∏è Por favor, introduce una respuesta v√°lida y completa (m√≠nimo 2 caracteres).", "bot");
        return;
    }
    // Validation for phone number check
    if (questionIndex === 3 && !/^\+?\d{7,20}$/.test(text.replace(/\s/g, ''))) {
        addMessage("‚ö†Ô∏è Por favor, introduce un formato de tel√©fono v√°lido (incluyendo c√≥digo de pa√≠s).", "bot");
        return;
    }

    
    // 3. Process and Advance
    addMessage(text,"user");
    answers.push(text);
    
    // *** FIX: Reset input area back to standard text input for the NEXT step ***
    currentInputContainer.innerHTML = `<input id="user-input" type="text" placeholder="Escribe tu respuesta y presiona Enter o Enviar...">`;
    sendBtn.textContent = "Enviar";
    sendBtn.disabled = false;

    // Advance to next question
    currentQuestion++;
    botAskNext();
});

// --- PERSONALIZATION LOGIC (Unchanged) ---
function getPersonalizedNotesAndName(answers) {
    // Note: Memory step is at answers[10]
    const memory = (answers[10] || '').toLowerCase(); 
    const intention = answers[8] || "Poder/Confianza";
    const userMemory = answers[10].length > 45 ? `${answers[10].substring(0, 45)}...` : answers[10];
    
    let topNotes, middleNotes, baseNotes, manifestoTitle, perfumeStory;
    let intentionDesc = intention.split('/')[0]; // Use primary intention for story (e.g., 'Poder')

    // (The complex logic for notes remains the same for consistency)
    if (memory.includes("mar") || memory.includes("agua") || memory.includes("tormenta")) {
        topNotes = "Sal Marina (Crisp), Pomelo Blanco, Hojas de Menta Fresca";
        middleNotes = "Alga Marina (Absolute), Cipr√©s, Neroli Tunecino"; 
        baseNotes = "√Åmbar Mineral, Vetiver de Java, Musgo Marino";
        manifestoTitle = "Manifesto Acu√°tico";
        perfumeStory = `**El Horizonte Inm√≥vil.** Esta composici√≥n evoca la inmensidad del mar, transformando el recuerdo de <STRONG>'${userMemory}'</STRONG> en una nota de fuerza. Su coraz√≥n mineral y acu√°tico se fusiona para proyectar una inigualable sensaci√≥n de <STRONG>${intentionDesc}</STRONG>.`;
    } else if (memory.includes("abuela") || memory.includes("hogar") || memory.includes("flores")) {
        topNotes = "T√© Blanco de Fujian, Bergamota Siciliana";
        middleNotes = "Rosa de Mayo, Gardenia, Vainilla Bourbon Cremosa"; 
        baseNotes = "Almizcle de Piel, Benju√≠, S√°ndalo cremoso";
        manifestoTitle = "Manifesto Ra√≠z";
        perfumeStory = `**El C√≠rculo de la Memoria.** La calidez de un hogar y el recuerdo de <STRONG>'${userMemory}'</STRONG> son destilados en esta esencia. Un coraz√≥n floral y cremoso que ancla, infundiendo una profunda sensaci√≥n de <STRONG>${intentionDesc}</STRONG> y reconexi√≥n con su origen.`;
    } else if (memory.includes("fuego") || memory.includes("monta√±a") || memory.includes("viaje")) {
        topNotes = "Cardamomo de India, Nuez Moscada, Ron A√±ejo";
        middleNotes = "Oud ahumado, Madera de Cedro, Cuero R√∫stico"; 
        baseNotes = "Pachul√≠ indonesio, Cacao, Musgo de Roble";
        manifestoTitle = "Manifesto Aventura";
        perfumeStory = `**La Estela del Explorador.** Un tributo olfativo al valor del viaje. Su an√©cdota de <STRONG>'${userMemory}'</STRONG> se traduce en una fragancia audaz, donde maderas y especias se combinan para proyectar una ineludible <STRONG>${intentionDesc}</STRONG> y poder.`;
    } else if (memory.includes("noche") || memory.includes("misterio") || memory.includes("sensualidad")) {
        topNotes = "Grosella Negra, Azafr√°n, Licor de Cereza"; 
        middleNotes = "Absoluto de Tuberosa, Iris de Florencia, Caf√© Ar√°bica";
        baseNotes = "Haba Tonka Tostada, √Åmbar Negro, Vainilla de Madagascar";
        manifestoTitle = "Manifesto Nocturno";
        perfumeStory = `**El Velo de Medianoche.** Una composici√≥n oscura y seductora. El deseo de evocar <STRONG>${intentionDesc}</STRONG> se captura con la profundidad del recuerdo de <STRONG>'${userMemory}'</STRONG>. Una estela de misterio y sofisticaci√≥n que se revela al caer la noche.`;
    } else {
        topNotes = "Mandarina Sanguina, Pimienta Rosa, Jengibre Cristalizado";
        middleNotes = "Jazm√≠n de Egipto, Madera de Cashmere, Incienso de Om√°n";
        baseNotes = "S√°ndalo Mysore, Vainilla Negra, Almizcle Blanco";
        manifestoTitle = "Manifesto Intemporel";
        perfumeStory = `**La Firma Atemporal.** Esta creaci√≥n se inspira en su deseo de manifestar <STRONG>${intentionDesc}</STRONG>. Hemos codificado la esencia de su recuerdo <STRONG>'${userMemory}'</STRONG> en una fragancia de elegancia universal y uso diario.`;
    }
    
    const firstNameInitial = (answers[1] || "C").charAt(0).toUpperCase();
    const perfumeName = `Sello Priv√©e ${firstNameInitial} - ${manifestoTitle}`;

    return { topNotes, middleNotes, baseNotes, perfumeName, perfumeStory };
}

// 6. FINAL PERFUME RESULT (Unchanged logic, uses new CSS variables)
function generatePerfumeDemo(){
  const firstName = answers[1] || "Cliente";
  const lastName = answers[2] || "";
  const projection = answers[6] ? answers[6].toLowerCase() : 'moderada';
  
  const { topNotes, middleNotes, baseNotes, perfumeName, perfumeStory } = getPersonalizedNotesAndName(answers);
  const selectedFlask = answers[9]; // The color chosen in step 9
  const concentrationRec = projection.includes('intensa') ? 'Elixir' : 'Eau de Parfum (EDP)';
  
  const perfumeData = {
    nombre_perfume_completo: perfumeName,
    codigo_olfativo: `SCNT-${firstName.toUpperCase().slice(0, 3)}${Date.now().toString().slice(-4)}-LUX`,
    notas_top: topNotes,
    notas_middle: middleNotes,
    notas_base: baseNotes,
    emociones: answers[8] || "Poder/Confianza",
    concentration: concentrationRec,
    descripcion: `SCENTIA ha destilado su memoria y su intenci√≥n en una <STRONG>carta olfativa</STRONG> √∫nica. Esta composici√≥n no es una fragancia, sino su historia, ahora codificada en la piel.`
  };
  
  addMessage(`***C√ìDIGO CERRADO.*** SCENTIA IA: HAS TRASCENDIDO LA ELECCI√ìN. ESTE ES TU MANIFIESTO PERSONAL.`, "bot", "revelation-message");
  addMessage(`üéâ <STRONG>¬°Felicidades, ${firstName} ${lastName}!</STRONG> Esta es la revelaci√≥n de tu esencia: <STRONG>${perfumeData.nombre_perfume_completo}</STRONG>.`, "bot");


  const card = document.createElement("div");
  card.className="fragrance-card";
  
  card.innerHTML = `
    <h3 style="margin-bottom: 5px; color: var(--color-accent); font-family: 'Playfair Display', serif; font-size: 32px;">${perfumeData.nombre_perfume_completo}</h3>
    <div class="subtitle" style="color: var(--color-text-subtle); margin-bottom: 30px;">
        Firma Olfativa | Frasco: <STRONG>${selectedFlask}</STRONG> | ${perfumeData.concentration}
    </div>
    
    <div class="story-box">
        <h4>Historia Olfativa - La Firma de la Memoria</h4>
        ${perfumeStory}
    </div>

    <div id="final-flask-preview-container" style="text-align: center; margin: 30px 0;">
        <img src="${flaskImages[selectedFlask]}" alt="Frasco de Perfume ${selectedFlask}" style="max-width: 180px; border: 4px solid var(--color-text-subtle); border-radius: 10px;">
    </div>
    
    <div class="olfactive-pyramid">
        <h4>Arquitectura Olfativa de Tres Actos</h4>
        
        <div class="note-layer">
            <span class="layer-title">üî∫ ACTO I: APERTURA (Notas de Salida)</span>
            <div class="layer-content">${perfumeData.notas_top}</div>
        </div>
        
        <div class="note-layer">
            <span class="layer-title">üåø ACTO II: CORAZ√ìN (Notas Medias)</span>
            <div class="layer-content">${perfumeData.notas_middle}</div>
        </div>
        
        <div class="note-layer">
            <span class="layer-title">üóÑÔ∏è ACTO III: FONDO (Notas Base)</span>
            <div class="layer-content">${perfumeData.notas_base}</div>
        </div>
    </div>

    <div class="signature-block">
        <strong>Firma Olfativa Certificada por SCENTIA ATELIER</strong>
        <p>Destilado para: ${firstName} ${lastName}</p>
        <p>Concentraci√≥n: ${perfumeData.concentration}</p>
        <div class="code">${perfumeData.codigo_olfativo}</div>
    </div>
    
    <button class="purchase-cta-bar">
        PASAR A LA P√ÅGINA DE COMPRA Y DESTILACI√ìN
    </button>
  `;
  
  // Checkout script (Updated for the 'Compra' transition look)
  card.querySelector('.purchase-cta-bar').addEventListener('click', () => {
      const finalFirstName = answers[1] || "Cliente";
      const message = `Su esencia ha sido transferida a la <STRONG>P√°gina de Compra Segura</STRONG>. El Atelier Priv√©e registrar√° el inicio de la destilaci√≥n de su Sello: ${perfumeData.codigo_olfativo}.`;
      
      const accent = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim();
      const primaryDark = getComputedStyle(document.documentElement).getPropertyValue('--color-primary-dark').trim();
      const textLight = getComputedStyle(document.documentElement).getPropertyValue('--color-text-light').trim();

      const dialog = document.createElement('div');
      dialog.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center;';
      dialog.innerHTML = `
          <div style="background: ${primaryDark}; padding: 40px; border-radius: 20px; text-align: center; max-width: 450px; box-shadow: 0 15px 40px rgba(0,0,0,0.7); animation: popin 0.4s forwards; color: ${textLight}; border: 3px solid ${accent};">
              <h4 style="color: ${accent}; font-family: 'Playfair Display', serif; font-size: 30px; margin-top: 0; letter-spacing: 1px;">Transici√≥n a Compra</h4>
              <p style="font-size: 17px; line-height: 1.7; margin-bottom: 30px;">
                <STRONG>¬°Felicidades!</STRONG> ${message}
              </p>
              <button onclick="this.closest('div').remove()" style="background: ${accent}; color: var(--color-primary-dark); border: none; padding: 15px 30px; border-radius: 12px; cursor: pointer; font-weight: 700; text-transform: uppercase;">Finalizar Consulta</button>
          </div>
          <style>@keyframes popin { from { opacity: 0; transform: scale(0.7); } to { opacity: 1; transform: scale(1); } }</style>
      `;
      document.body.appendChild(dialog);
  });

  setTimeout(() => {
      chatWindow.appendChild(card);
      chatWindow.scrollTop = chatWindow.scrollHeight;
  }, 500);
}

// Start conversation
addMessage("üëã Hola. Soy <STRONG>SCENTIA IA</STRONG>, tu asistente privado. Iniciaremos la formulaci√≥n de tu <STRONG>perfume personalizado</STRONG>.", "bot");
botAskNext(); 
</script>
</body>
</html>
